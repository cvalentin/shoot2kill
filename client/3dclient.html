<!doctype html>
<html lang="en">
<head>
	<title>Three.js -- Template</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body style="overflow:hidden;">
<style>
canvas {
	position:absolute;
	top:0;
	left:0;
}
</style>
<script src="http://127.0.0.1:1500/socket.io/socket.io.js"></script>
<script src="./vector.js"></script>
<script src="./Three.js"></script>

<script>
Array.prototype.remove = function(from, to) {
  var rest = this.slice((to || from) + 1 || this.length);
  this.length = from < 0 ? this.length + from : from;
  return this.push.apply(this, rest);
};


var _socket = io.connect('http://127.0.0.1:1500');

var MATS = {}

var scene, camera, renderer, floor;

var _added_players = [];
var _added_bullets = [];

var _cur_player_id = 0;
var _last_data;


window.onload = function() {
	init();
	
	_socket.on('connect', function(data){
		_last_data = data;
		draw(data);
	});
	_socket.on('server_push', function(data){
		_last_data = data;
		draw(_last_data);
		renderer.clear();
		renderer.render( scene, camera );
	});
}

function init() {
	scene = new THREE.Scene();
	var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
	var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
	camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
	scene.add(camera);
	renderer = new THREE.WebGLRenderer( {antialias:true} );
	renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
	var container = document.createElement('div');
	document.body.appendChild( container );
	container.appendChild( renderer.domElement );


	// FLOOR
	var floorTexture = new THREE.ImageUtils.loadTexture( 'images/ground.jpg' );
	floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
	floorTexture.repeat.set( 20, 20 );
	var floorMaterial = new THREE.MeshBasicMaterial( { map: floorTexture, side: THREE.DoubleSide } );
	var floorGeometry = new THREE.PlaneGeometry(10000, 10000, 10, 10);
	floor = new THREE.Mesh(floorGeometry, floorMaterial);
	floor.position.y = -0.5;
	floor.rotation.z = Math.PI / 2;
	MATS.FLOOR = floorMaterial;
	
	var player_texture = THREE.ImageUtils.loadTexture( 'images/guy.png' );
	var player_material = new THREE.SpriteMaterial( { map: player_texture, useScreenCoordinates: false, color: 0xffffff } );
	MATS.PLAYER = player_material;
	
	var bullet_texture = THREE.ImageUtils.loadTexture( 'images/bullet.png' );
	var bullet_material = new THREE.SpriteMaterial( { map: bullet_texture, useScreenCoordinates: false, color: 0xffffff } );
	MATS.BULLET = bullet_material;
	camera.up.set(0,0,1);
}

function draw(jso) {
	if (!jso) return;

	while(scene.children.length > 0) {
		scene.remove(scene.children[0]);
	}
	_added_players = [];
	_added_bullets= [];
	scene.add(floor);
	var curplayer = null;
	
	jso.players.forEach(function(i) {
		var cgetp = cons_player(i.pos.x,i.pos.y);
		if (i.id == _cur_player_id) curplayer = i;
		_added_players.push(cgetp);
	});
	
	jso.bullets.forEach(function(i) {
		var cgetb = cons_bullet(i.pos.x,i.pos.y);
		_added_bullets.push(cgetb);
	});
	
	if (curplayer) {
	//if (false) {
		camera.position.set(curplayer.pos.x,curplayer.pos.y,50);
		camera.lookAt({
			x:curplayer.pos.x+curplayer.dir.x*10,
			y:curplayer.pos.y+curplayer.dir.y*10,
			z:50});
		console.log(curplayer.pos.x+","+curplayer.pos.y);
	} else {
		camera.up.set(0,0,1);
		camera.position.set(0,0,1000);
		camera.lookAt({x:0,y:0,z:0});
	}
	
}

function cons_bullet(x,y) {
	var bullet = new THREE.Sprite( MATS.BULLET );
	bullet.position.set( x,y,25);
	bullet.scale.set(64,64,1.0);
	scene.add(bullet);
	return bullet;
}

function cons_player(x,y) {
	var player = new THREE.Sprite( MATS.PLAYER );
	player.position.set( x,y, 25 );
	player.scale.set( 64, 64, 1.0 ); // imageWidth, imageHeight
	scene.add( player );
	return player;
}

document.onkeydown = function(e) {
return;
	if (e.keyCode == 37) {//lurd
		_dirv = rotate_by(_dirv,0.3);
		
	} else if (e.keyCode == 38) {
		_pos.x += _dirv.x*20;
		_pos.y += _dirv.y*20;
	
	} else if (e.keyCode == 39) {
		_dirv = rotate_by(_dirv,-0.3);;
	
	} else if (e.keyCode == 40) {
		_pos.x -= _dirv.x*20;
		_pos.y -= _dirv.y*20;
	}
	camera.position.set(_pos.x,_pos.y,50);
	camera.lookAt({x:_pos.x+_dirv.x*10,y:_pos.y+_dirv.y*10,z:50});
}


</script>

</body>
</html>
