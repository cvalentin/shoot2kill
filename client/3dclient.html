<!doctype html>
<html lang="en">
<head>
	<title>Three.js -- Template</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body style="overflow:hidden;">
<style>
canvas {
	position:absolute;
	top:0;
	left:0;
}
</style>
<script src="controls.js"></script>
<script src="http://127.0.0.1:1500/socket.io/socket.io.js"></script>
<script src="./vector.js"></script>
<script src="./Three.js"></script>

<script>
Array.prototype.remove = function(from, to) {
  var rest = this.slice((to || from) + 1 || this.length);
  this.length = from < 0 ? this.length + from : from;
  return this.push.apply(this, rest);
};


var _socket = io.connect('http://127.0.0.1:1500');

var MATS = {}

var scene, camera, renderer, floor;

var _added_players = [];
var _added_bullets = [];

var _cur_player_id = 0;
var _last_data;

var enter_chat = null;


window.onload = function() {
	init();
	
	_socket.on('connect', function(data){
		_last_data = data;
		draw(data);
	});
	_socket.on('server_push', function(data){
		_last_data = data;
		draw(_last_data);
		renderer.clear();
		renderer.render( scene, camera );
	});
	
	setInterval(function() {
		update();
	},50);
	
	_socket.emit('player_request_id', {name: "test"},function(id){
		_cur_player_id = id;
	});
		document.addEventListener("keydown", _controls_keydown);
	document.addEventListener("keyup",_controls_keyup);
}

function update() {
	var curplayer = null;
	if (!_last_data) return;
	_last_data.players.forEach(function(i) {
		if (i.id == _cur_player_id) curplayer = i;
	});
	if (!curplayer) {
		return;
	}
	
	if (KEYS_DOWN["turnleft"]) {
		_socket.emit("turn",{"id":_cur_player_id,"theta":0.135});
		
	} 
	if (KEYS_DOWN["turnright"]) {
		_socket.emit("turn",{"id":_cur_player_id,"theta":-0.135});
	
	} 
	if (KEYS_DOWN["forward"]) {
		var dirv = $V([curplayer.dir.x,curplayer.dir.y,0]);
		dirv.scalem(7.5);
		_socket.emit("move",{"id":_cur_player_id,"dirv":cons_point(dirv.x(),dirv.y())});
	
	} 
	if (KEYS_DOWN["backward"]) {
		var dirv = $V([curplayer.dir.x,curplayer.dir.y,0]);
		dirv.scalem(-7.5);
		_socket.emit("move",{"id":_cur_player_id,"dirv":cons_point(dirv.x(),dirv.y())});
	}
}

function fire() {
	if(_cur_player_id < 0) return;
	_socket.emit("fire",{"id":_cur_player_id});
}


function init() {
	scene = new THREE.Scene();
	var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
	var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
	camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
	scene.add(camera);
	renderer = new THREE.WebGLRenderer( {antialias:true} );
	renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
	var container = document.createElement('div');
	document.body.appendChild( container );
	container.appendChild( renderer.domElement );

	var wallTexture = new THREE.ImageUtils.loadTexture( 'images/wall.png' );
	wallTexture.wrapS = wallTexture.wrapT = THREE.RepeatWrapping; 
	wallTexture.repeat.set(1,1);
	var wallMaterial = new THREE.MeshBasicMaterial( { map: wallTexture, side: THREE.DoubleSide } );
	MATS.WALL = wallMaterial;
	
	var floorTexture = new THREE.ImageUtils.loadTexture( 'images/ground.jpg' );
	floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
	floorTexture.repeat.set( 20, 20 );
	var floorMaterial = new THREE.MeshBasicMaterial( { map: floorTexture, side: THREE.DoubleSide } );
	MATS.FLOOR = floorMaterial;
	
	var floorGeometry = new THREE.PlaneGeometry(10000, 10000, 10, 10);
	floor = new THREE.Mesh(floorGeometry, MATS.FLOOR);
	floor.position.y = -0.5;
	floor.rotation.z = Math.PI / 2;
	
	var player_texture = THREE.ImageUtils.loadTexture( 'images/guy.png' );
	var player_material = new THREE.SpriteMaterial( { map: player_texture, useScreenCoordinates: false, color: 0xffffff } );
	MATS.PLAYER = player_material;
	
	var bullet_texture = THREE.ImageUtils.loadTexture( 'images/bullet.png' );
	var bullet_material = new THREE.SpriteMaterial( { map: bullet_texture, useScreenCoordinates: false, color: 0xffffff } );
	MATS.BULLET = bullet_material;
	camera.up.set(0,0,1);
}

function cons_wall(x,y,wid,hei) {
	var wallgeo = new THREE.PlaneGeometry(wid, 500, 10, 10);
	wall = new THREE.Mesh(wallgeo, MATS.WALL);
	wall.rotation.x = Math.PI/2;
	wall.translateX(wid/2);
	wall.translateX(x);
	wall.translateY(y);
	_walls.push(wall);
	scene.add(wall);
	
	wall = new THREE.Mesh(wallgeo, MATS.WALL);
	wall.rotation.x = Math.PI/2;
	wall.rotation.y = Math.PI/2;
	wall.translateY(-wid/2);
		wall.translateX(x);
	wall.translateY(y);
	_walls.push(wall);
	scene.add(wall);
	

	wall = new THREE.Mesh(wallgeo, MATS.WALL);
	wall.rotation.x = Math.PI/2;
	wall.rotation.y = Math.PI/2;
	wall.translateY(-wid/2);
	wall.translateX(wid);
		wall.translateX(x);
	wall.translateY(y);
	_walls.push(wall);
	scene.add(wall);
	
	wall = new THREE.Mesh(wallgeo, MATS.WALL);
	wall.rotation.x = Math.PI/2;
	wall.translateX(wid/2);
	wall.translateY(-hei);
	wall.translateX(x);
	wall.translateY(y);
	_walls.push(wall);
	scene.add(wall);
}

var _walls = [];

window.onbeforeunload = function(){
	_socket.emit('logoff', {id:_cur_player_id});
}

function draw(jso) {
	if (!jso) return;

	while(scene.children.length > 0) {
		scene.remove(scene.children[0]);
	}
	scene.add(floor);
	var curplayer = null;
	
	if (_walls.length == 0) {
		jso.walls.forEach(function(i) {
			cons_wall(i.x,i.y,i.width,i.height);
		});
	} else {
		_walls.forEach(function(i){
			scene.add(i);
		});
	}
	
	jso.players.forEach(function(i) {
		var cgetp = cons_player(i.pos.x,i.pos.y);
		if (i.id == _cur_player_id) curplayer = i;
	});
	
	jso.bullets.forEach(function(i) {
		var cgetb = cons_bullet(i.pos.x,i.pos.y);
	});
	
	if (curplayer) {
		camera.position.set(curplayer.pos.x,curplayer.pos.y,50);
		camera.lookAt({
			x:curplayer.pos.x+curplayer.dir.x*10,
			y:curplayer.pos.y+curplayer.dir.y*10,
			z:50});
	} else {
		camera.up.set(0,0,1);
		camera.position.set(0,0,1000);
		camera.lookAt({x:0,y:0,z:0});
	}
	
}

function cons_bullet(x,y) {
	var bullet = new THREE.Sprite( MATS.BULLET );
	bullet.position.set( x,y,25);
	bullet.scale.set(64,64,1.0);
	scene.add(bullet);
	return bullet;
}

function cons_player(x,y) {
	var player = new THREE.Sprite( MATS.PLAYER );
	player.position.set( x,y, 25 );
	player.scale.set( 64, 64, 1.0 ); // imageWidth, imageHeight
	scene.add( player );
	return player;
}

</script>

</body>
</html>
